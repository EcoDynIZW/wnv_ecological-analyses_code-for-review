---
title: "WNS bloodmeals in mosquitoes in Berlin 2023 and 2024"
author: "Steph Kramer kramer@izw-berlin.de"
date: "`r Sys.setlocale('LC_TIME','C'); paste('Last Update', format(Sys.time(), '%B %e, %Y')) `"
output:
  rmdformats::readthedown:
    highlight: kate
    code_folding: show
    toc_depth: 4
    toc_float: true
editor_options:
  chunk_output_type: console
params:
  date: !r Sys.Date()
---

<style>
h1 {
  color: Orange ;
}
h2, h3, h4, h5, h6, legend {
  color: Indigo ;
}
p {
  line-height:170%;
}
{
sidebar h2 {
  background-color: Indigo;
}
code {
  color: Indigo ;
}
.exercise {
  color: #824b00;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, 
                      dev = "ragg_png", fig.width = 9, fig.height = 6, dpi = 600, retina = 1)
Sys.setlocale("LC_TIME", "C")
```


# Analysis of mosquito data

## Settings

```{r}
data_year <- 9999 ## set at the beginning - set to 9999 if data_years are combined
suffix_for_plot <- "_mosquito-data_"

source(here::here('R','source-file-with-helper-functions.R'))

str(mymosq)
```


## Prepare dataset

### Separate mosquitoes into sus and inf
```{r}

## copy dataset
tmp <- mymosq

## delete 19th of June in 2023 data set
myrow <- which(tmp$Date == '2023-06-19')
myrow
if (length(myrow) > 0) {tmp <- tmp[-myrow,] } 

## delete column of unidentifieds
a1 <- which(names(tmp) == "AB_unidentified")
a2 <- which(names(tmp) == "WNV_unidentified")
tmp1 <- tmp[, -c(a1,a2)]

## select only the columns with mosquitoes
i <- grep("AB_", names(tmp1) )
length(i)                ## this is mosquito diversity across all sites
ab_mosq <- tmp1[,c(1,i)]

## select only the columns with infected
j <- grep("WNV_", names(tmp1) )
length(j)             ## this is infected mosquito diversity across all sites
ab_mosq_wnv <- tmp1[,c(1,j)]


## ab_mosq and ab_mosq_wnv used for further analyses

```

### Create lists with colSums
```{r}

AB_mosq_site <- tapply(ab_mosq[,-1], ab_mosq$site, colSums ) ## first column needs to be taken out
AB_wnv_site <- tapply(ab_mosq_wnv[,-1], ab_mosq_wnv$site, colSums ) 

### continue here
AB_mosq_list <- list('RB' = unname(AB_mosq_site$RB),
                     'RA' = unname(AB_mosq_site$RA),
                     'S' = unname(AB_mosq_site$S),
                     'C' = unname(AB_mosq_site$C),
                     'N' = unname(AB_mosq_site$N)
                     )
AB_mosq_list


AB_wnv_list <- list('RB' = unname(AB_wnv_site$RB),
                     'RA' = unname(AB_wnv_site$RA),
                     'S' = unname(AB_wnv_site$S),
                     'C' = unname(AB_wnv_site$C),
                     'N' = unname(AB_wnv_site$N)
                     )
AB_wnv_list

```

## Calculate MIR

### MIR per site
```{r}
MIR_rb <- round(sum(AB_wnv_list$RB) / sum(AB_mosq_list$RB) * 1000 , digits=2); MIR_rb
MIR_ra <- round(sum(AB_wnv_list$RA) / sum(AB_mosq_list$RA) * 1000 , digits=2); MIR_ra
MIR_s <- round(sum(AB_wnv_list$S) / sum(AB_mosq_list$S) * 1000 , digits=2); MIR_s
MIR_c <- round(sum(AB_wnv_list$C) / sum(AB_mosq_list$C) * 1000 , digits=2); MIR_c
MIR_n <- round(sum(AB_wnv_list$N) / sum(AB_mosq_list$N) * 1000 , digits=2); MIR_n

## MIR changes in C if not only Culex is considered, 
## infection in A vexans, but only 1 of 20 - neglected because it does not
## reflect the processes in the field
```

### MIR per site and species
```{r}
if (data_year != 2024) {

  wnv_inf_spec <- gsub(pattern = "WNV_", replacement = "",x= names(ab_mosq_wnv))
  ab_mosq_spec <- gsub(pattern = "AB_" , replacement = "",x= names(ab_mosq))
  
  a <- which(ab_mosq_spec %in% wnv_inf_spec)
  ab_mosq_spec_with_inf <- ab_mosq[,a]
  
  sum_mosq_spec_with_inf <- tapply(ab_mosq_spec_with_inf[,-1],
                                  ab_mosq_spec_with_inf$site, 
                                  colSums)
  
  mir_site_spec = mapply(FUN = `/`, 
                               AB_wnv_site, sum_mosq_spec_with_inf, 
                               SIMPLIFY = FALSE)
  
  mir_site_spec = mapply(FUN = function(val1) round(val1*1000, digits = 2), 
                         mir_site_spec, 
                         SIMPLIFY = FALSE)
  
  AB_wnv_beta_rel_as_df <- as.data.frame(mir_site_spec)

  ft <- flextable(AB_wnv_beta_rel_as_df)
  save_as_docx(ft, path =  paste0(dir_output_path,
                    "/ft_wnv_mir_per_species_and_site",
                    suffix_for_plot,today,".docx"))
}

```


## Rarefaction mosquitoes

### Fig S1
```{r}
mosq_div0 <- iNEXT(AB_mosq_list, q=0, datatype="abundance") 

mosq_div0$AsyEst ## save this output
write.csv(x = mosq_div0$AsyEst, 
   file = paste0(dir_output_path,"/Rarefaction_mosq",
            suffix_for_plot,today,".csv"))


#### Hill q = 0 ; richness/ diversity
## TODO re-level legend to have RB RA S C N
g0 <- ggiNEXT(mosq_div0, type=1, se=TRUE, facet.var="None",
              color.var="Assemblage", 
              grey=FALSE) +
       scale_colour_manual(values = site.cols) +
       scale_fill_manual(values = site.cols) +
       ylab('Diversity of mosquito species') + 
       xlab('Number of mosquitoes')
g0

pdf(paste0(dir_plot_path,"/Fig_S1_rarefaction_mosq_q0_",data_year,suffix_for_plot,today,".pdf"), 
      width = 10, height = 10) 
  grid.arrange(g0, ncol=1)
dev.off()


```


### Fig Shannon- and Simpson-like

```{r}
#### Hill q = 1 ; Shannon like
mosq_div1 <- iNEXT(AB_mosq_list, q=1, datatype="abundance")
g1 <- ggiNEXT(mosq_div1, type=1, se=TRUE, facet.var="None",  color.var="Assemblage", 
        grey=FALSE) +
  theme(legend.position="right") +
  ylab('Hill number  q = 1') +
  guides(linetype=guide_legend(title="Method"), 
        colour=guide_legend(title="Site"), 
        fill=guide_legend(title="Site"), 
        shape=guide_legend(title="Site")) +
       scale_colour_manual(values = site.cols) +
       scale_fill_manual(values = site.cols) +
       xlab('Number of mosquitoes')

g1

pdf(paste0(dir_plot_path,"/Fig_rarefaction_mosq_q1_",data_year,suffix_for_plot,today,".pdf"), 
      width = 10, height = 10) 
  grid.arrange(g1, ncol=1)
dev.off()


#### Hill q = 2 ; Simpson like
mosq_div2 <- iNEXT(AB_mosq_list, q=2, datatype="abundance")
g2 <- ggiNEXT(mosq_div2, type=1, se=TRUE, facet.var="None", color.var="Assemblage", 
        grey=FALSE) +
  theme_bw(base_size = 18) +
  theme(legend.position="right") +
  ylab('Hill number  q = 2') +
  guides(linetype=guide_legend(title="Method"), 
        colour=guide_legend(title="Site"), 
        fill=guide_legend(title="Site"), 
        shape=guide_legend(title="Site")) +
         scale_colour_manual(values = site.cols) +
       scale_fill_manual(values = site.cols) +
       xlab('Number of mosquitoes')
g2

pdf(paste0(dir_plot_path,"/Fig_rarefaction_mosq_q2_",data_year,suffix_for_plot,today,".pdf"), 
      width = 10, height = 10) 
  grid.arrange(g2, ncol=1)
dev.off()
```


### Fig WNV infected

```{r, eval=FALSE}
## makes no sense for 2024 as there is no diversity in infected, only inf in Culex

# if (lapply(AB_wnv_list, length)[1] > 1) { ## more elegant to avoid the year setting
if (data_year != 2024) {
wnv_div0 <- iNEXT(AB_wnv_list, q=0, datatype="abundance") 
wnv_r <- ggiNEXT(wnv_div0, type=1, se=TRUE, facet.var="None",
              color.var="Assemblage", grey=FALSE) + 
  scale_colour_manual(values = site.cols) +
  scale_fill_manual(values = site.cols) +
  ylab('Diversity of WNV-infected mosquito species') + 
  xlab('Number of samples')

plot(wnv_r)

pdf(paste0(dir_plot_path,"/Fig_rarefaction_wnv_q0_",data_year,suffix_for_plot,today,".pdf"), 
      width = 10, height = 10) 
  grid.arrange(wnv_r, ncol=1)
dev.off()
}
```


## Bray-Curtis similarity

### BC for mosquitos

```{r}
AB_mosq_beta <- t(as.data.frame(AB_mosq_list))

BC_vegan_diss <- round(vegdist(AB_mosq_beta, method = 'bray'),digits=2)
(BC_vegan_sim <- 1-BC_vegan_diss)

## convert to data.frame to save it as table
tmp1 <- as.matrix(BC_vegan_sim)
tmp2 <- as.data.frame(tmp1,row.names=rownames(tmp1))
tmp2$site <-rownames(tmp1) 
#tmp2

ft <- flextable(tmp2)
save_as_docx(ft, path =  paste0(dir_output_path,
             "/ft_AB_mosq_BrayCurtis_similarity",suffix_for_plot,today,".docx"))

```

### BC for WNV abundance

do not run this for 2024, but AB_wnv_beta needed for MIR

```{r}
AB_wnv_beta <- t(as.data.frame(AB_wnv_list))

if(data_year != 2024){
  BC_wnv_diss <- round(vegdist(AB_wnv_beta, method = 'bray'),digits=2)
  (BC_wnv_sim <- 1-BC_wnv_diss) ## similarity

  tmp1 <- as.matrix(BC_wnv_sim)
  tmp2 <- as.data.frame(tmp1,row.names=rownames(tmp1))
  tmp2$site <-rownames(tmp1) 
  #tmp2
    ft <- flextable(tmp2)
    save_as_docx(ft, path =  paste0(dir_output_path,
                    "/ft_wnv_abs_BrayCurtis_similarity",suffix_for_plot,today,".docx"))
}

```


### BC for MIR

Not for 2024 data
```{r}
if (data_year != 2024) {
  AB_wnv_beta_rel <- t(as.data.frame(mir_site_spec)) ## see MIR per site and species


  BC_wnv_diss_rel <- round(vegdist(AB_wnv_beta_rel, method = 'bray'),digits=2)
  BC_wnv_sim_rel <- 1-BC_wnv_diss_rel
  BC_wnv_sim_rel #similarity

  tmp1 <- as.matrix(BC_wnv_sim_rel)
  tmp2 <- as.data.frame(tmp1,row.names=rownames(tmp1))
  tmp2$site <-rownames(tmp1) 
  #tmp2


  ## this is similarity in infected species groups, not in total inf
  ft <- flextable(tmp2)
  save_as_docx(ft, path =  paste0(dir_output_path,
                    "/ft_wnv_mir_BrayCurtis_similarity",suffix_for_plot,today,".docx"))
}

```





## Hierarchical cluster analysis

Check association of mosquitoes. 


### Fig 5A Mosquito abuncance (log)

```{r}
my_a <- data.matrix(AB_mosq_beta)

## give back the mosquito names without AB in front
dimnames(my_a) <- list(rownames(my_a),
                       gsub(pattern="AB_",replacement = "",
                            x = names(ab_mosq)[-1])) 

my_a

## take the log of the abundance and add 1 to avoid zero issue
## zeros will stay 0, but we have to add to the 1 for the color scale
## to avoid that o and 1 are coerced
my_a_log <- log2(my_a+1)

#create the breaks to draw 0 found in grey
bk2 = unique(seq(0, round(max(my_a_log)), length=round(max(my_a_log))+1))
  
a <- which(my_a_log == 1)
my_a_log[a] <- 1.1 ## trick to distinguish 0 from 1 in breaks

#set different color vectors for each interval
col1 = rep("lightgrey", 1) # set 0 to grey
col2 <- inferno(round(max(my_a_log))+1)
colors2 <- c(col1, col2)

p_heat <- pheatmap(my_a_log, color=colors2, breaks=bk2, fontsize = 16) # logarithm!

pdf(paste0(dir_plot_path,"/Fig_5A_heat_mosqAB_log_",data_year,suffix_for_plot,today,".pdf"), 
      width = 12, height = 10) 
  p_heat
dev.off()
```

### Fig 5B Absolute values (wnv counts) of infected

In 2024 only 1 infected species, so skip for 2024
```{r}
if (data_year != 2024) {
  my_b <- data.matrix(AB_wnv_beta)

  ## give back the infected mosquito names without WNV in front
  dimnames(my_b) <- list(rownames(my_b),
                       gsub(pattern="WNV_",replacement = "",
                            x = names(ab_mosq_wnv)[-1])) 


  my_b
  
  #create the breaks to draw 0 found in grey
  bk2 = unique(seq(0, max(my_b), length=max(my_b)+1))
  
  a <- which(my_b == 1)
  my_b[a] <- 1.1 ## trick to distinguish 0 from 1 in breaks

  #set different color vectors for each interval
  col1 = rep("lightgrey", 1) # set 0 to grey
  col2 <- inferno(max(my_b)+1)
  colors2 <- c(col1, col2)
  
  #draw heatmap
  p_heat_wnv <- pheatmap(my_b, color=colors2, breaks=bk2, fontsize= 16) ##

  pdf(paste0(dir_plot_path,"/Fig5B_heat_wnvAB_",data_year,suffix_for_plot,today,".pdf"), 
      width = 10, height = 10) 
    p_heat_wnv
  dev.off()

}

```


### Fig 5C Relative infection prob per relative mosq abundance

Not for 2024
```{r}

if (data_year != 2024) {
## colour breaks / quantiles
my_c <- data.matrix(AB_wnv_beta_rel)
my_c 


quantile_breaks <- function(xs, n = 10) {
  breaks <- quantile(xs, probs = seq(0, 1, length.out = n))
  breaks[!duplicated(breaks)]
}
mat_breaks <- quantile_breaks(my_c, n = 49)


p_heat_wnv_rel <- pheatmap(mat = my_c, 
                           color = inferno(length(mat_breaks) - 1),
                           breaks= mat_breaks,
                           fontsize=16) 
p_heat_wnv_rel

pdf(paste0(dir_plot_path,"/Fig_5C_heat_wnv_mir_",data_year,suffix_for_plot,today,".pdf"), 
      width = 12, height = 10) 
  p_heat_wnv_rel
dev.off()

}

```




<br><hr><br>

<details><summary>Session Info</summary>

```{r sessionInfo}
Sys.time()
#git2r::repository() ## uncomment if you are using GitHub
sessionInfo()
```

</details>
